import maya.cmds as cmds

def create_snow_block_shader(shader_name="Snow_Block_MAT"):
    """
    Creates an Arnold aiStandardSurface snow material with:
    - Procedural color variation (noise)
    - Procedural bump (fractal/noise)
    - Optional icy edge tint using facingRatio
    Assign it to selected objects (or returns shading group for manual assignment).
    """

    # --- Safety checks ---
    if not cmds.pluginInfo("mtoa", q=True, loaded=True):
        try:
            cmds.loadPlugin("mtoa")
        except Exception:
            cmds.warning("Arnold (mtoa) plugin is not loaded. Load it first.")
            return None

    # If material exists, reuse
    if cmds.objExists(shader_name):
        shader = shader_name
    else:
        shader = cmds.shadingNode("aiStandardSurface", asShader=True, name=shader_name)

    # Shading group
    sg = shader + "SG"
    if not cmds.objExists(sg):
        sg = cmds.sets(renderable=True, noSurfaceShader=True, empty=True, name=sg)
        cmds.connectAttr(shader + ".outColor", sg + ".surfaceShader", force=True)

    # --- Base look: stylized snow ---
    # Snow tends to be rough and bright, with soft spec
    cmds.setAttr(shader + ".base", 1.0)
    cmds.setAttr(shader + ".baseColor", 0.92, 0.94, 0.98, type="double3")  # cool white
    cmds.setAttr(shader + ".specular", 0.25)   # subtle sparkle
    cmds.setAttr(shader + ".specularRoughness", 0.55)
    cmds.setAttr(shader + ".subsurface", 0.25)  # soft "powdery" feel
    cmds.setAttr(shader + ".subsurfaceRadius", 0.8, 1.0, 1.2, type="double3")

    # --- Procedural color variation (noise) ---
    # Create noise texture
    color_noise = cmds.shadingNode("noise", asTexture=True, name=shader_name + "_colorNoise")
    color_place = cmds.shadingNode("place2dTexture", asUtility=True, name=shader_name + "_colorPlace2d")
    # Connect place2d -> noise
    for attr in ("coverage","translateFrame","rotateFrame","mirrorU","mirrorV","stagger",
                 "wrapU","wrapV","repeatUV","offset","rotateUV","noiseUV","vertexUvOne",
                 "vertexUvTwo","vertexUvThree","vertexCameraOne"):
        cmds.connectAttr(color_place + "." + attr, color_noise + "." + attr, force=True)
    cmds.connectAttr(color_place + ".outUV", color_noise + ".uvCoord", force=True)
    cmds.connectAttr(color_place + ".outUvFilterSize", color_noise + ".uvFilterSize", force=True)

    # Tune noise for subtle variation
    cmds.setAttr(color_noise + ".frequency", 6.0)
    cmds.setAttr(color_noise + ".amplitude", 0.18)
    cmds.setAttr(color_noise + ".ratio", 0.75)

    # Blend baseColor with noise using a multiply
    mult = cmds.shadingNode("multiplyDivide", asUtility=True, name=shader_name + "_colorMult")
    cmds.setAttr(mult + ".input1", 0.92, 0.94, 0.98, type="double3")  # base snow tint
    cmds.connectAttr(color_noise + ".outColor", mult + ".input2", force=True)

    # Clamp to avoid dark spots (optional)
    clamp = cmds.shadingNode("clamp", asUtility=True, name=shader_name + "_clamp")
    cmds.setAttr(clamp + ".minR", 0.80); cmds.setAttr(clamp + ".minG", 0.82); cmds.setAttr(clamp + ".minB", 0.88)
    cmds.setAttr(clamp + ".maxR", 1.00); cmds.setAttr(clamp + ".maxG", 1.00); cmds.setAttr(clamp + ".maxB", 1.00)
    cmds.connectAttr(mult + ".output", clamp + ".input", force=True)

    cmds.connectAttr(clamp + ".output", shader + ".baseColor", force=True)

    # --- Bump (snow grain) ---
    bump_noise = cmds.shadingNode("fractal", asTexture=True, name=shader_name + "_bumpFractal")
    bump_place = cmds.shadingNode("place2dTexture", asUtility=True, name=shader_name + "_bumpPlace2d")
    for attr in ("coverage","translateFrame","rotateFrame","mirrorU","mirrorV","stagger",
                 "wrapU","wrapV","repeatUV","offset","rotateUV","noiseUV","vertexUvOne",
                 "vertexUvTwo","vertexUvThree","vertexCameraOne"):
        cmds.connectAttr(bump_place + "." + attr, bump_noise + "." + attr, force=True)
    cmds.connectAttr(bump_place + ".outUV", bump_noise + ".uvCoord", force=True)
    cmds.connectAttr(bump_place + ".outUvFilterSize", bump_noise + ".uvFilterSize", force=True)

    cmds.setAttr(bump_noise + ".alphaGain", 0.55)
    cmds.setAttr(bump_noise + ".alphaOffset", 0.0)
    cmds.setAttr(bump_noise + ".frequencyRatio", 2.1)
    cmds.setAttr(bump_noise + ".amplitude", 0.7)

    bump = cmds.shadingNode("bump2d", asUtility=True, name=shader_name + "_bump2d")
    cmds.setAttr(bump + ".bumpDepth", 0.08)  # keep subtle for stylized Mario look
    cmds.connectAttr(bump_noise + ".outAlpha", bump + ".bumpValue", force=True)
    cmds.connectAttr(bump + ".outNormal", shader + ".normalCamera", force=True)

    # --- Optional icy edge tint (facing ratio) ---
    # This gives a slight bluish highlight near grazing angles (reads like icy edge)
    facing = cmds.shadingNode("facingRatio", asUtility=True, name=shader_name + "_facingRatio")
    ramp = cmds.shadingNode("ramp", asTexture=True, name=shader_name + "_iceRamp")
    ramp_place = cmds.shadingNode("place2dTexture", asUtility=True, name=shader_name + "_rampPlace2d")
    for attr in ("coverage","translateFrame","rotateFrame","mirrorU","mirrorV","stagger",
                 "wrapU","wrapV","repeatUV","offset","rotateUV","noiseUV","vertexUvOne",
                 "vertexUvTwo","vertexUvThree","vertexCameraOne"):
        cmds.connectAttr(ramp_place + "." + attr, ramp + "." + attr, force=True)
    cmds.connectAttr(ramp_place + ".outUV", ramp + ".uvCoord", force=True)
    cmds.connectAttr(ramp_place + ".outUvFilterSize", ramp + ".uvFilterSize", force=True)

    cmds.setAttr(ramp + ".type", 1)  # V Ramp
    # Set ramp colors (white -> icy blue)
    # (We won't micromanage all ramp entries; use default + tweak)
    cmds.setAttr(ramp + ".colorEntryList[0].color", 0.92, 0.94, 0.98, type="double3")
    cmds.setAttr(ramp + ".colorEntryList[1].position", 1.0)
    cmds.setAttr(ramp + ".colorEntryList[1].color", 0.70, 0.85, 1.00, type="double3")

    # Connect facing ratio to ramp
    cmds.connectAttr(facing + ".outValue", ramp + ".vCoord", force=True)

    # Blend ramp with current baseColor
    blend = cmds.shadingNode("blendColors", asUtility=True, name=shader_name + "_iceBlend")
    cmds.setAttr(blend + ".blender", 0.25)  # subtle icy edge strength
    cmds.connectAttr(clamp + ".output", blend + ".color1", force=True)
    cmds.connectAttr(ramp + ".outColor", blend + ".color2", force=True)

    cmds.connectAttr(blend + ".output", shader + ".baseColor", force=True)

    # --- Assign to selection (if any) ---
    sel = cmds.ls(selection=True, long=True) or []
    if sel:
        cmds.sets(sel, e=True, forceElement=sg)

    return {"shader": shader, "shadingGroup": sg}

create_snow_block_shader()
